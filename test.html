<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <style>
        html {background-color: white;}
        code {color:green;}
    </style>
</head>
<body>
<pre><code></code></pre>
<script>
    (function() {
        var ERROR = {event:'error'};
        var EXIT = {event:'exit'};
        var PROVIDECODE = {event:'provideCode'};

        var send = window.callPhantom ? window.callPhantom : function(data){console.log(JSON.stringify(data))};

        var i = 0;
        var code = send(PROVIDECODE);
        if (!code) {
            send(ERROR);
            document.body.innerHTML = '<h1>Could not get code!</h1>';
            return;
        }

        var e = document.querySelector('code');
        var renderNextLetter = function() {
            var c = code.charAt(i++);
            if (c !== '') {
                e.textContent += c;
                if (send({event:'renderReady',msg:i/code.length})) {
                    window.requestAnimationFrame(renderNextLetter);
                } else {
                    send(ERROR);
                }
            } else {
                send(EXIT);
            }
        };
        setTimeout(renderNextLetter,1000);
    })();
</script>
</body>
</html>
