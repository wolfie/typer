<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <style>
        html {background-color: white;}
        code {color:green;}
    </style>
</head>
<body>
<pre><code></code></pre>
<script>
    (function() {
        var ERROR = {event:'error'};
        var EXIT = {event:'exit'};
        var PROVIDECODE = {event:'provideCode'};
        var codeElement = document.querySelector('code');
        var renderRequest = 0;

        var phantomIsPresent = function() { return typeof window.callPhantom === 'function'; };

        var render = function(code) {
            codeElement.textContent = '';
            window.cancelAnimationFrame(renderRequest);

            var i = 0;
            var renderNextLetter = function() {
                var c = code.charAt(i++);
                if (c !== '') {
                    codeElement.textContent += c;
                    if (!phantomIsPresent() || send({event:'renderReady',msg:i/code.length})) {
                        renderRequest = window.requestAnimationFrame(renderNextLetter);
                    } else {
                        send(ERROR);
                    }
                } else {
                    send(EXIT);
                }
            };
            renderNextLetter();
        };

        var send = phantomIsPresent() ? window.callPhantom : function(data){console.log(JSON.stringify(data))};

        if (phantomIsPresent()) {
            var code = send(PROVIDECODE);
            if (!code) send(ERROR);
            else render(code);
        } else {
            var textarea = document.createElement('textarea');
            textarea.style.width = '600px';
            textarea.style.height = '300px';

            var button = document.createElement('button');
            button.textContent = 'Type';
            button.addEventListener('click', function() {
                render(textarea.value);
            });

            document.body.insertBefore(button, document.body.firstChild);
            document.body.insertBefore(textarea, document.body.firstChild);
        }
    })();
</script>
</body>
</html>
